@page "/"
@using LudoStatsApp.Models
@using LudoStatsApp.Services
@inject GameStorageService Storage
@inject IJSRuntime JS

<h2 class="title">📊 Ludo Dashboard</h2>

<div class="card">
    <canvas id="winsChart" height="120"></canvas>
</div>

<div class="card">
    <h3>🎲 Add Game</h3>

    <label>Players</label>
    <ul class="player-list">
        @foreach (var p in Players)
        {
            <li>@p.Name</li>
        }
    </ul>

    <label>Winner</label>
    <select class="input" @bind="SelectedWinner">
        <option value="">-- Select Winner --</option>
        @foreach (var p in Players)
        {
            <option value="@p.Name">@p.Name</option>
        }
    </select>

    <br />
    <button class="btn-save" @onclick="SaveGame">💾 Save Game</button>
</div>

<style>
    /* General page styling */
    .title {
        margin-bottom: 20px;
        color: #2c3e50;
        font-weight: 600;
        font-size: 24px;
    }

    /* Card style */
    .card {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        background-color: #fff;
    }

    /* Player list styling */
    .player-list {
        list-style-type: disc;
        padding-left: 20px;
        margin-bottom: 10px;
    }

        .player-list li {
            padding: 4px 0;
            color: #34495e;
            font-weight: 500;
        }

    /* Winner dropdown styling */
    .input {
        width: 220px;
        padding: 6px 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
    }

    /* Save button styling */
    .btn-save {
        padding: 8px 14px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
    }

        .btn-save:hover {
            background-color: #45a049;
        }

    /* Card headings */
    .card h3 {
        margin-bottom: 10px;
        color: #2c3e50;
        font-weight: 600;
    }

    label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
        color: #34495e;
    }
</style>

@code {
    List<GameResult> Games = new();
    List<Player> Players = new();
    string SelectedWinner = "";

    bool refreshChart = false;

    protected override void OnInitialized()
    {
        Players = Storage.GetPlayers();
        Games = Storage.GetGames();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || refreshChart)
        {
            refreshChart = false;
            await LoadChart();
        }
    }

    async Task LoadChart()
    {
        var stats = Games
            .GroupBy(g => g.Winner)
            .Select(g => new
            {
                Player = g.Key,
                Wins = g.Count()
            })
            .ToList();

        await JS.InvokeVoidAsync(
            "renderWinChart",
            stats.Select(s => s.Player).ToArray(),
            stats.Select(s => s.Wins).ToArray()
        );
    }

    void SaveGame()
    {
        if (string.IsNullOrWhiteSpace(SelectedWinner))
            return;

        Games.Add(new GameResult
        {
            Winner = SelectedWinner
        });

        Storage.SaveGames(Games);

        SelectedWinner = "";

        refreshChart = true;
        StateHasChanged();
    }
}
